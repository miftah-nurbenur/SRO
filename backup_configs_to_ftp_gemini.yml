---
- name: Backup Cisco IOS configs and Upload to FTP
  hosts: all
  gather_facts: false
  connection: network_cli

  vars:
    ansible_network_os: cisco.ios.ios
    backup_root: "/tmp/config-backups"

    # FTP Details - Ensuring lowercase as per your text prompt
    ftp_host: "10.201.6.41"
    ftp_user: "netadmin"
    ftp_pass: "Testing@123"
    ftp_remote_dir: "config-backups"

  tasks:
    - name: Generate and freeze timestamp
      ansible.builtin.set_fact:
        timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
      run_once: true
      delegate_to: localhost

    - name: Define Archive Name
      ansible.builtin.set_fact:
        archive_file: "network_backups_{{ timestamp }}.tar.gz"
      run_once: true

    - name: Create local backup directory
      ansible.builtin.file:
        path: "{{ backup_root }}/{{ timestamp }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: true

    - name: Get running and startup configs from Routers
      cisco.ios.ios_command:
        commands:
          - show running-config
          - show startup-config
      register: device_configs

    - name: Save configs locally
      ansible.builtin.copy:
        content: "{{ item.content }}"
        dest: "{{ backup_root }}/{{ timestamp }}/{{ inventory_hostname }}-{{ item.suffix }}.cfg"
      loop:
        - { content: "{{ device_configs.stdout[0] }}", suffix: "running" }
        - { content: "{{ device_configs.stdout[1] }}", suffix: "startup" }
      delegate_to: localhost

    - name: Create compressed archive
      ansible.builtin.shell: "tar -czf {{ backup_root }}/{{ archive_file }} -C {{ backup_root }}/{{ timestamp }} ."
      delegate_to: localhost
      run_once: true

    - name: Upload archive to FTP
      ansible.builtin.shell: >
        curl --fail --ftp-pasv --disable-epsv --ftp-create-dirs
        --user '{{ ftp_user }}:{{ ftp_pass }}'
        -T "{{ backup_root }}/{{ archive_file }}"
        "ftp://{{ ftp_host }}/{{ ftp_remote_dir }}/"
      delegate_to: localhost
      run_once: true
      register: ftp_upload
      ignore_errors: true

    - name: Diagnostic - If upload failed, show server response
      ansible.builtin.debug:
        msg: "FTP Error Detected. Check if password '{{ ftp_pass }}' is correct for user '{{ ftp_user }}' on the FTP server."
      when: ftp_upload.rc != 0
      run_once: true

    - name: Cleanup local files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_root }}/{{ timestamp }}"
        - "{{ backup_root }}/{{ archive_file }}"
      delegate_to: localhost
      run_once: true
      when: ftp_upload.rc == 0
