---
- name: Backup Cisco IOS configs and Upload to FTP
  hosts: all
  gather_facts: false
  connection: network_cli

  vars:
    ansible_network_os: cisco.ios.ios
    # Local workspace on the Ansible controller (AWX)
    backup_root: "/tmp/config-backups"
    timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
    archive_file: "network_backups_{{ timestamp }}.tar.gz"
    
    # FTP Details
    ftp_host: "10.201.6.41"
    ftp_user: "netadmin"
    ftp_pass: "testing@123" # Fixed case sensitivity from your prompt
    ftp_remote_dir: "config-backups"

  tasks:
    - name: Create local backup directory
      ansible.builtin.file:
        path: "{{ backup_root }}/{{ timestamp }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: true

    - name: Fetch Running Config
      cisco.ios.ios_config:
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname }}-running.cfg"
          dir_path: "{{ backup_root }}/{{ timestamp }}"
      register: backup_info

    - name: Fetch Startup Config
      cisco.ios.ios_command:
        commands:
          - show startup-config
      register: start_cfg

    - name: Save Startup Config to local file
      ansible.builtin.copy:
        content: "{{ start_cfg.stdout[0] }}"
        dest: "{{ backup_root }}/{{ timestamp }}/{{ inventory_hostname }}-startup.cfg"
        mode: "0644"
      delegate_to: localhost

    - name: Create compressed archive of all backups
      community.general.archive:
        path: "{{ backup_root }}/{{ timestamp }}"
        dest: "{{ backup_root }}/{{ archive_file }}"
        format: gz
      delegate_to: localhost
      run_once: true

    - name: Upload archive to FTP
      ansible.builtin.command: >
        curl --fail --ftp-create-dirs -T "{{ backup_root }}/{{ archive_file }}"
        "ftp://{{ ftp_user }}:{{ ftp_pass }}@{{ ftp_host }}/{{ ftp_remote_dir }}/"
      delegate_to: localhost
      run_once: true
      no_log: true

    - name: Cleanup local files (Optional)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_root }}/{{ timestamp }}"
        - "{{ backup_root }}/{{ archive_file }}"
      delegate_to: localhost
      run_once: true

    - name: Publish AWX Artifacts
      ansible.builtin.set_stats:
        data:
          ftp_target: "ftp://{{ ftp_host }}/{{ ftp_remote_dir }}/{{ archive_file }}"
      run_once: true
