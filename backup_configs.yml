---
- name: Backup Cisco IOS running & startup config (all routers in inventory)
  hosts: all
  gather_facts: false
  connection: network_cli

  vars:
    ansible_network_os: cisco.ios.ios
    backup_root: "/runner/artifacts/config-backups"

  tasks:
    - name: Ensure backup directory exists (on runner)
      delegate_to: localhost
      run_once: true
      ansible.builtin.file:
        path: "{{ backup_root }}"
        state: directory
        mode: "0755"

    - name: Get timestamp (once per host)
      delegate_to: localhost
      ansible.builtin.set_fact:
        ts: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

    - name: Get running-config
      cisco.ios.ios_command:
        commands:
          - "show running-config"
      register: run_cfg
      changed_when: false

    - name: Get startup-config
      cisco.ios.ios_command:
        commands:
          - "show startup-config"
      register: start_cfg
      changed_when: false

    - name: Save running-config (timestamped)
      delegate_to: localhost
      ansible.builtin.copy:
        content: "{{ run_cfg.stdout[0] | default('') }}"
        dest: "{{ backup_root }}/{{ inventory_hostname }}-running-{{ ts }}.cfg"
        mode: "0644"

    - name: Save startup-config (timestamped)
      delegate_to: localhost
      ansible.builtin.copy:
        content: "{{ start_cfg.stdout[0] | default('') }}"
        dest: "{{ backup_root }}/{{ inventory_hostname }}-startup-{{ ts }}.cfg"
        mode: "0644"

    - name: Create compressed archive of all backups (once)
      delegate_to: localhost
      run_once: true
      ansible.builtin.shell: |
        cd /runner/artifacts && \
        tar czf config-backups-{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}.tar.gz config-backups
      args:
        executable: /bin/bash

    - name: Find latest backup archive
      delegate_to: localhost
      run_once: true
      ansible.builtin.shell: |
        ls -1t /runner/artifacts/config-backups-*.tar.gz | head -1
      register: archive_path
      changed_when: false

    - name: Publish artifact paths to AWX (shows in Job -> Details -> Artifacts)
      delegate_to: localhost
      run_once: true
      ansible.builtin.set_stats:
        data:
          backup_directory: "{{ backup_root }}"
          backup_archive: "{{ archive_path.stdout | trim }}"
